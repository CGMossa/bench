---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
options(width = 120)
```
# bench

[![Travis build status](https://travis-ci.org/jimhester/bench.svg?branch=master)](https://travis-ci.org/jimhester/bench)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/jimhester/bench?branch=master&svg=true)](https://ci.appveyor.com/project/jimhester/bench)

The goal of bench is to benchmark code.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("jimhester/bench")
```

## Example

`bench::mark()` a function to easily benchmark a series of expressions and
evaluate relative performance.

```{r example, error = TRUE}
set.seed(42)
dat <- data.frame(x = runif(10000, 1, 1000), y=runif(10000, 1, 1000))

# Throws an error if the results are not equivalent, so you don't accidentally
# benchmark against the wrong answer
results <- bench::mark(
  y = dat[dat$x > 500, ],
  x = dat[which(dat$x > 499), ],
  subset(dat, x > 500))

results <- bench::mark(
  dat[dat$x > 500, ],
  dat[which(dat$x > 500), ],
  subset(dat, x > 500))

results
```

```{r example2, cache = TRUE}
set.seed(42)

create_df <- function(rows, cols) {
  as.data.frame(setNames(
    replicate(cols, runif(rows, 1, 1000), simplify = FALSE),
    rep_len(c("x", letters), cols)))
}

results <- bench::mark(
  setup = dat <- create_df(rows, cols),
  parameters = list(rows = c(10000, 100000), cols = c(10, 100)),
  min_time = .5,
  min_iterations = 100,

  dat[dat$x > 500, ],
  dat[which(dat$x > 500), ],
  subset(dat, x > 500))
```

```{r pressure, message = FALSE, warning = FALSE, cache = TRUE, dependson = "example2"}
library(tidyverse)
results %>%
  select(expression, rows, cols, time, gc) %>%
  unnest() %>%
  mutate(gc =
    case_when(
      level2 > 0 ~ "level2",
      level1 > 0 ~ "level1",
      level0 > 0 ~ "level0",
      TRUE ~ "none")) %>%
  mutate(gc = factor(gc, c("none", "level0", "level1", "level2"))) %>%
  ggplot(aes(x = expression, y = time, color = gc)) +
    geom_jitter() +
    coord_flip() +
    scale_color_brewer(type = "qual", palette = 3) +
    facet_grid(rows ~ cols, labeller = label_both)
```

Also includes `system_time()`, a higher precision replacement for `system.time()`

```{r}
bench::system_time({ i <- 1; while(i < 1e7) i <- i + 1 })
bench::system_time(Sys.sleep(.5))
```
